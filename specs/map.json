{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "width": 900,
  "height": 600,
  "title": { "text": "Koala sightings (ALA) vs Protected Areas (CAPAD)", "anchor": "start" },

  "projection": {
    "type": "albers",
    "rotate": [-132, 0, 0],
    "parallels": [-18, -36],
    "center": [0, -27],
    "scale": 1200
  },

  "params": [
    { "name": "year_sel", "value": 2021,
      "bind": { "input": "range", "min": 2000, "max": 2025, "step": 1, "name": "Year " } },
    { "name": "state_sel", "value": "All",
      "bind": { "input": "select",
        "options": ["All","New South Wales","Queensland","Victoria","South Australia"],
        "name": " State " } }
  ],

  "layer": [
    {
      "data": { "graticule": { "step": [30, 30] } },
      "mark": { "type": "geoshape", "stroke": "#d7d7d7", "strokeWidth": 0.6, "fillOpacity": 0 }
    },
    {
      "data": {
        "url": "https://cdn.jsdelivr.net/npm/vega-datasets@2/data/world-110m.json",
        "format": { "type": "topojson", "feature": "countries" }
      },
      "transform": [{ "filter": "datum.id == 36" }],
      "mark": {
        "type": "geoshape",
        "fill": "#4b4f57",
        "stroke": "#6b6f77",
        "strokeWidth": 0.8
      }
    },
    {
      "data": {
        "url": "data/capad_2022_simplified.topo.json",
        "format": { "type": "topojson", "feature": "capad" }
      },
      "mark": {
        "type": "geoshape",
        "fillOpacity": 0,
        "stroke": "#a9adb4",
        "strokeOpacity": 0.75,
        "strokeWidth": 0.55
      },
      "encoding": {
        "tooltip": [
          { "field": "properties.NAME",  "type": "nominal", "title": "Protected Area" },
          { "field": "properties.IUCN",  "type": "nominal", "title": "IUCN" },
          { "field": "properties.STATE", "type": "nominal", "title": "State" }
        ]
      }
    },
    {
      "data": { "url": "data/occ_koala_recent.csv" },
      "transform": [
        { "sample": 5000 },
        { "calculate": "toDate(datum.eventDate)", "as": "event_dt" },
        { "calculate": "year(datum.event_dt)", "as": "year" },
        { "filter": "isValid(datum.lon) && isValid(datum.lat)" },
        { "filter": "datum.lat >= -45 && datum.lat <= -10 && datum.lon >= 110 && datum.lon <= 155" },
        { "filter": "datum.year == year_sel" },
        { "filter": "state_sel == 'All' || datum.state == state_sel" }
      ],
      "mark": { "type": "circle", "size": 28, "opacity": 0.95, "stroke": "#000", "strokeWidth": 0.35 },
      "encoding": {
        "longitude": { "field": "lon", "type": "quantitative" },
        "latitude":  { "field": "lat", "type": "quantitative" },
        "color":     { "value": "red" },
        "tooltip": [
          { "field": "species",   "type": "nominal",  "title": "Species" },
          { "field": "eventDate", "type": "temporal", "title": "Date" },
          { "field": "state",     "type": "nominal",  "title": "State" }
        ]
      }
    }
  ],

  "config": {
    "axis":   { "labelFontSize": 12, "titleFontSize": 12 },
    "legend": { "labelFontSize": 12, "titleFontSize": 12 },
    "title":  { "fontSize": 18 },
    "view":   { "stroke": "transparent" }
  }
}
